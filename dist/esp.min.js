// notice_start
/*
 * Copyright 2015 Keith Woods
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
 // notice_end

!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.esp=t():e.esp=t()}(this,function(){return function(e){function t(r){if(n[r])return n[r].exports;var o=n[r]={exports:{},id:r,loaded:!1};return e[r].call(o.exports,o,o.exports,t),o.loaded=!0,o.exports}var n={};return t.m=e,t.c=n,t.p="",t(0)}([function(e,t,n){"use strict";t.ObservationStage=n(8),t.Router=n(25),t.model=n(15)},function(e,t,n){"use strict";function r(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t["default"]=e,t}function o(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(t,"__esModule",{value:!0});var i=n(29),u=o(i),s=n(3),a=o(s),l=n(30),c=r(l),f=n(10),d=r(f);t["default"]={disposables:u["default"],Guard:a["default"],logger:c,utils:d},e.exports=t["default"]},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),u=n(1),s=n(7),a=r(s),l=function(){function e(t){o(this,e),this._observe=t}return i(e,null,[{key:"create",value:function(t){u.Guard.lengthIs(arguments,1,"Incorrect argument count on Observable, expect 1 onObserve function");var n=function(e){return t(e)};return new e(n)}}]),i(e,[{key:"observe",value:function(){var e;if(1===arguments.length&&arguments[0]instanceof a["default"])e=arguments[0];else{u.Guard.lengthIsAtLeast(arguments,1,"Incorrect args count of "+arguments.length);var t=arguments[0],n=arguments.length>=1?arguments[1]:void 0,r=arguments.length>=2?arguments[2]:void 0;e=new a["default"](t,n,r)}return u.Guard.isDefined(this._observe,"_observe not set"),this._observe(e)}}]),e}();t["default"]=l,e.exports=t["default"]},function(e,t,n){"use strict";function r(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t["default"]=e,t}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e){if("undefined"==typeof e||""===e)throw new Error("Argument error");throw new Error(e)}Object.defineProperty(t,"__esModule",{value:!0});var u=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),s=n(10),a=r(s),l=function(){function e(){o(this,e)}return u(e,null,[{key:"isDefined",value:function(e,t){"undefined"==typeof e&&i(t)}},{key:"isFalsey",value:function(e,t){e&&i(t)}},{key:"lengthIs",value:function(e,t,n){e.length!==t&&i(n)}},{key:"lengthGreaterThan",value:function(e,t,n){e.length<t&&i(n)}},{key:"lengthIsAtLeast",value:function(e,t,n){e.length<t&&i(n)}},{key:"isString",value:function(e,t){a.isString(e)||i(t)}},{key:"isTrue",value:function(e,t){e||i(t)}},{key:"isFunction",value:function(e,t){"function"!=typeof e&&i(t)}},{key:"isNumber",value:function(e,t){isNaN(e)&&i(t)}},{key:"isObject",value:function(e,t){"object"!=typeof e&&i(t)}}]),e}();t["default"]=l,e.exports=t["default"]},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),u=n(3),s=r(u),a=function(){function e(t){o(this,e),s["default"].isDefined(t,"disposable must be defined");var n;if("function"==typeof t)n={dispose:function(){t()}};else{if(!t.dispose||"function"!=typeof t.dispose)throw new Error("Item to dispose was neither a function nor had a dispose method.");n={dispose:function(){t.dispose&&"function"==typeof t.dispose&&t.dispose()}}}this._isDisposed=!1,this._disposable=n}return i(e,[{key:"dispose",value:function(){!this._isDisposed&&this._disposable&&(this._isDisposed=!0,this._disposable.dispose())}},{key:"isDisposed",get:function(){return this._isDisposed}}]),e}();t["default"]=a,e.exports=t["default"]},function(e,t){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),o=function(){function e(){n(this,e),this._checkIsLocked=function(){return!0}}return r(e,[{key:"ensureLocked",value:function(){if(this._checkIsLocked())throw new Error("Model is locked, can't edit")}},{key:"isLocked",get:function(){return this._checkIsLocked()}}]),e}();t["default"]=o,e.exports=t["default"]},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(t,"__esModule",{value:!0});var o=n(13),i=r(o),u=n(14),s=r(u);t["default"]={AsyncWorkCompleteEvent:i["default"],ModelChangedEvent:s["default"]},e.exports=t["default"]},function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),i=n(1),u=function(){function e(t,n,o){r(this,e),i.Guard.isDefined(t,"onObserve Required"),this._hasError=!1,this._hasCompleted=!1,this._onNext=t,this._onError=function(e){if("undefined"==typeof n||"function"!=typeof n)throw e;n(e)},this._onCompleted=function(){"undefined"!=typeof o&&"function"==typeof o&&o()}}return o(e,[{key:"onNext",value:function(e,t,n){this._hasError||this._hasCompleted||this._onNext(e,t,n)}},{key:"onError",value:function(e){this._hasError||(this._hasError=!0,this._onError(e))}},{key:"onCompleted",value:function(){this._hasCompleted||(this._hasCompleted=!0,this._onCompleted())}}]),e}();t["default"]=u,e.exports=t["default"]},function(e,t){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),o=function(){function e(){n(this,e)}return r(e,null,[{key:"preview",get:function(){return"preview"}},{key:"normal",get:function(){return"normal"}},{key:"committed",get:function(){return"committed"}}]),e}();t["default"]=o,e.exports=t["default"]},function(e,t){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),o=function(){function e(){n(this,e)}return r(e,null,[{key:"Idle",get:function(){return"idle"}},{key:"PreEventProcessing",get:function(){return"preEventProcessorDispatch"}},{key:"EventProcessorDispatch",get:function(){return"eventProcessorDispatch"}},{key:"EventExecution",get:function(){return"eventProcessorExecution"}},{key:"PostProcessing",get:function(){return"postEventProcessorDispatch"}},{key:"DispatchModelUpdates",get:function(){return"dispatchModelUpdates"}},{key:"Halted",get:function(){return"halted"}}]),e}();t["default"]=o,e.exports=t["default"]},function(e,t){"use strict";function n(e,t){for(var n=e.length;n--;)e[n]===t&&e.splice(n,1)}function r(e){return"string"==typeof e||e instanceof String}function o(e){var t=Array.prototype.slice.call(arguments,1),n=e.replace(/{(\d+)}/g,function(e,n){return"undefined"!=typeof t[n]?t[n]:e});return n}Object.defineProperty(t,"__esModule",{value:!0}),t.removeAll=n,t.isString=r,t.format=o},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),u=n(1),s=r(u),a=function(){function e(){o(this,e),this._disposables=new s["default"].disposables.CompositeDisposable}return i(e,[{key:"addDisposable",value:function(e){this._disposables.add(e)}},{key:"dispose",value:function(){this._disposables.dispose()}},{key:"isDisposed",get:function(){return this._disposables.isDisposed}}]),e}();t["default"]=a,e.exports=t["default"]},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var u=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),s=function(e,t,n){for(var r=!0;r;){var o=e,i=t,u=n;s=l=a=void 0,r=!1,null===o&&(o=Function.prototype);var s=Object.getOwnPropertyDescriptor(o,i);if(void 0!==s){if("value"in s)return s.value;var a=s.get;return void 0===a?void 0:a.call(u)}var l=Object.getPrototypeOf(o);if(null===l)return void 0;e=l,t=i,n=u,r=!0}},a=n(5),l=r(a),c=function(e){function t(){o(this,t),s(Object.getPrototypeOf(t.prototype),"constructor",this).call(this),this._isLocked=!0,this._checkIsLocked=function(){return this._isLocked}.bind(this)}return i(t,e),u(t,[{key:"lock",value:function(){this._isLocked=!0}},{key:"unlock",value:function(){this._isLocked=!1}},{key:"bindLockPredicate",value:function(){this._bindLockPredicate(this)}},{key:"_bindLockPredicate",value:function(e){e=e||this;for(var t in e)if(e.hasOwnProperty(t)){var n=e[t];n instanceof l["default"]&&(n._checkIsLocked=this._checkIsLocked,this._bindLockPredicate(n))}}}]),t}(l["default"]);t["default"]=c,e.exports=t["default"]},function(e,t){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),o=function(){function e(t,r,o){n(this,e),this._operationId=t,this._results=r,this._isFinished=o}return r(e,[{key:"operationId",get:function(){return this._operationId}},{key:"results",get:function(){return this._results}},{key:"isFinished",get:function(){return this._isFinished}}]),e}();t["default"]=o,e.exports=t["default"]},function(e,t){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),o=function(){function e(t,r){n(this,e),this._modelId=t,this._eventType=r}return r(e,[{key:"modelId",get:function(){return this._modelId}},{key:"eventType",get:function(){return this._eventType}}]),e}();t["default"]=o,e.exports=t["default"]},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(t,"__esModule",{value:!0});var o=n(6),i=r(o),u=n(11),s=r(u),a=n(5),l=r(a),c=n(12),f=r(c);t["default"]={events:i["default"],DisposableBase:s["default"],ModelBase:l["default"],ModelRootBase:f["default"]},e.exports=t["default"]},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function u(e){var t=this;return this._observers.push(e),{dispose:function(){l.utils.removeAll(t._observers,e)}}}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),a=function(e,t,n){for(var r=!0;r;){var o=e,i=t,u=n;s=l=a=void 0,r=!1,null===o&&(o=Function.prototype);var s=Object.getOwnPropertyDescriptor(o,i);if(void 0!==s){if("value"in s)return s.value;var a=s.get;return void 0===a?void 0:a.call(u)}var l=Object.getPrototypeOf(o);if(null===l)return void 0;e=l,t=i,n=u,r=!0}},l=n(1),c=n(2),f=r(c),d=function(e){function t(){o(this,t),a(Object.getPrototypeOf(t.prototype),"constructor",this).call(this,void 0),this._observe=u.bind(this),this._observers=[],this._hasComplete=!1,this._hasError=!1}return i(t,e),s(t,[{key:"onNext",value:function(e,t,n){if(!this._hasComplete)for(var r=this._observers.slice(0),o=0,i=r.length;i>o&&!this._hasError;o++){var u=r[o];try{u.onNext(e,t,n)}catch(s){this._hasError=!0,this._error=s,u.onError(s)}}}},{key:"onCompleted",value:function(){if(!this._hasComplete&&!this._hasError){this._hasComplete=!0;for(var e=this._observers.slice(0),t=0,n=e.length;n>t;t++){var r=e[t];r.onCompleted()}}}},{key:"onError",value:function(e){if(!this._hasError){this._hasError=!0;for(var t=this._observers.slice(0),n=0,r=t.length;r>n;n++){var o=t[n];o.onError(e)}}}},{key:"getObserverCount",value:function(){return this._observers.length}},{key:"hasError",get:function(){return this._hasError}},{key:"error",get:function(){return this._error}}]),t}(f["default"]);t["default"]=d,e.exports=t["default"]},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}var o=n(2),i=r(o);i["default"].prototype.asObservable=function(){var e=this,t=function(t){return e.observe(function(e,n,r){t.onNext(e,n,r)},t.onError.bind(t),function(){return t.onCompleted()})};return new i["default"](t)}},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}var o=n(2),i=r(o),u=n(1);i["default"].prototype["do"]=function(e){u.Guard.isFunction(e,"provided value isn't a function");var t=this,n=function(n){return t.observe(function(t,r,o){e(t,r,o),n.onNext(t,r,o)},n.onError.bind(n),function(){return n.onCompleted()})};return new i["default"](n)}},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}var o=n(2),i=r(o),u=n(1);i["default"].prototype.take=function(e){u.Guard.isNumber(e,"provided value isn't a number");var t=this,n=0,r=!1,o=function(o){return t.observe(function(t,i,u){n++;var s=!e||e>=n;s&&o.onNext(t,i,u);var a=!e||n>=e;!r&&a&&(r=!0,o.onCompleted())},o.onError.bind(o),function(){return o.onCompleted()})};return new i["default"](o)}},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}var o=n(2),i=r(o),u=n(1);i["default"].prototype.where=function(e){u.Guard.isDefined(e,"predicate Required");var t=this,n=function(n){return t.observe(function(t,r,o){e(t,r,o)&&n.onNext(t,r,o)},n.onError.bind(n),function(){return n.onCompleted()})};return new i["default"](n)}},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e["default"]:e}Object.defineProperty(t,"__esModule",{value:!0}),n(20),n(17),n(19),n(18);var o=n(2);t.Observable=r(o);var i=n(7);t.Observer=r(i);var u=n(16);t.Subject=r(u)},function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),i=n(1),u=function(){function e(t,n,o){r(this,e),i.Guard.isString(t,"The modelId should be a string"),i.Guard.isString(n,"The eventType should be a string"),i.Guard.isDefined(o,"The event should be defined"),this._modelId=t,this._eventType=n,this._event=o,this._isCanceled=!1,this._isCommitted=!1}return o(e,[{key:"cancel",value:function(){if(this._isCanceled)throw new Error("event is already cancelled");this._isCanceled=!0}},{key:"commit",value:function(){if(this._isCommitted)throw"event is already committed";this._isCommitted=!0}},{key:"isCanceled",get:function(){return this._isCanceled}},{key:"isCommitted",get:function(){return this._isCommitted}},{key:"modelId",get:function(){return this._modelId}},{key:"event",get:function(){return this._event}},{key:"eventType",get:function(){return this._eventType}}]),e}();t["default"]=u,e.exports=t["default"]},function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),i=n(1),u=function(){function e(t,n,o){r(this,e),this._modelId=t,this._model=n,this._eventQueue=[],this._hasChanges=!1,this._wasRemoved=!1,this._runPreEventProcessor=this._createEventProcessor("preEventProcessor",o?o.preEventProcessor:void 0),this._runPostEventProcessor=this._createEventProcessor("postEventProcessor",o?o.postEventProcessor:void 0)}return o(e,[{key:"_createEventProcessor",value:function(e,t){if(t){var n="function"==typeof t||"function"==typeof t.process;return i.Guard.isTrue(n,e+" should be a function or an object with a process() function"),function(n,r,o){if("function"==typeof t)t(n,r,o);else{if("function"!=typeof t.process)throw new Error(e+" is neither a function or an object with a process() method");t.process(n,r,o)}}}return function(){}}},{key:"modelId",get:function(){return this._modelId}},{key:"model",get:function(){return this._model}},{key:"eventQueue",get:function(){return this._eventQueue}},{key:"hasChanges",get:function(){return this._hasChanges},set:function(e){this._hasChanges=e}},{key:"wasRemoved",get:function(){return this._wasRemoved},set:function(e){this._wasRemoved=e}},{key:"runPreEventProcessor",get:function(){return this._runPreEventProcessor}},{key:"runPostEventProcessor",get:function(){return this._runPostEventProcessor}}]),e}();t["default"]=u,e.exports=t["default"]},function(e,t){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),o=function(){function e(t,r){n(this,e),this._underlying=t,this._targetModelId=r}return r(e,[{key:"publishEvent",value:function(e,t){this._underlying.publishEvent(this._targetModelId,e,t)}},{key:"executeEvent",value:function(e,t){this._underlying.executeEvent(e,t)}},{key:"getEventObservable",value:function(e,t){return this._underlying.getEventObservable(this._targetModelId,e,t)}},{key:"getModelObservable",value:function(){return this._underlying.getModelObservable(this._targetModelId)}}]),e}();t["default"]=o,e.exports=t["default"]},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),u=n(22),s=r(u),a=n(8),l=r(a),c=n(23),f=r(c),d=n(26),h=r(d),v=n(9),p=r(v),y=n(24),_=r(y),b=n(21),g=n(6),m=n(1),w=m.logger.create("Router"),k=function(){function e(){o(this,e),this._models={},this._modelUpdateSubjects={},this._modelEventSubjects={},this._haltingException=void 0,this._state=new h["default"]}return i(e,[{key:"registerModel",value:function(e,t,n){this._throwIfHalted(),m.Guard.isString(e,"The modelId argument should be a string"),m.Guard.isDefined(t,"THe model argument must be defined"),n&&m.Guard.isObject(n,"The options argument should be an object"),m.Guard.isFalsey(this._models[e],"The model with id ["+e+"] is already registered"),this._models[e]=new f["default"](e,t,n)}},{key:"removeModel",value:function(e){m.Guard.isString(e,"The modelId argument should be a string");var t=this._models[e];if(t){t.wasRemoved=!0,delete this._models[e],t.eventQueue.length=0;var n=this._modelUpdateSubjects[e];n&&(delete this._modelUpdateSubjects[e],n.onCompleted());var r=this._modelEventSubjects[e];if(r){delete this._modelEventSubjects[e];for(var o in r)if(r.hasOwnProperty(o)){var i=r[o];i.preview.onCompleted(),i.normal.onCompleted(),i.committed.onCompleted()}}}}},{key:"publishEvent",value:function(e,t,n){if(m.Guard.isString(e,"The modelId argument should be a string"),m.Guard.isString(t,"The eventType argument should be a string"),m.Guard.isDefined(n,"The event argument must be defined"),this._throwIfHalted(),this._state.currentStatus===p["default"].EventExecution)throw new Error("You can not publish further events when performing an event execution. modelId1: ["+e+"], eventType:["+t+"]");this._eventQueue(e,t,n),this._purgeEventQueues()}},{key:"broadcastEvent",value:function(e,t){m.Guard.isString(e,"The eventType argument should be a string"),m.Guard.isDefined(t,"The event argument should be defined");for(var n in this._models)this._models.hasOwnProperty(n)&&this._eventQueue(n,e,t);this._purgeEventQueues()}},{key:"executeEvent",value:function(e,t){var n=this;this._throwIfHalted(),m.Guard.isString(e,"The eventType argument should be a string"),m.Guard.isDefined(t,"The event argument should be defined"),this._state.executeEvent(function(){var r=new s["default"](n._state.currentModelId,e,t);n._dispatchEventToEventProcessors(n._state.currentModelId,n._state.currentModel,t,e,r)})}},{key:"getEventObservable",value:function(e,t,n){var r=this;return b.Observable.create(function(o){r._throwIfHalted(),m.Guard.isString(e,"The modelId argument should be a string"),m.Guard.isDefined(e,"The modelId argument should be defined"),m.Guard.isDefined(t,"The eventType argument should be defined"),n?(m.Guard.isString(n,"The stage argument should be a string"),m.Guard.isTrue(n===l["default"].preview||n===l["default"].normal||n===l["default"].committed,"The stage argument value of ["+n+"] is incorrect. It should be preview, normal or committed.")):n=l["default"].normal;var i=r._getModelsEventSubjects(e,t),u=i[n];return u.observe(o)})}},{key:"getModelObservable",value:function(e){var t=this;return b.Observable.create(function(n){t._throwIfHalted(),m.Guard.isString(e,"The modelId should be a string");var r=t._modelUpdateSubjects[e];return"undefined"==typeof r&&(r=new b.Subject,t._modelUpdateSubjects[e]=r),r.observe(n)})}},{key:"createModelRouter",value:function(e){return m.Guard.isString(e,"The targetModelId argument should be a string"),new _["default"](this,e)}},{key:"_eventQueue",value:function(e,t,n){if("modelChangedEvent"!==t||n.modelId!==e){var r=this._models[e];if("undefined"==typeof r)throw new Error("Can not publish event of type ["+t+"] as model with id ["+e+"] not registered");try{var o=!1,i=this._modelEventSubjects[e];"undefined"!=typeof i&&i.hasOwnProperty(t)&&(o=!0),o&&(r.eventQueue.push({eventType:t,event:n}),this._purgeEventQueues())}catch(u){this._halt(u)}}}},{key:"_getModelsEventSubjects",value:function(e,t){var n=this._modelEventSubjects[e];"undefined"==typeof n&&(n={},this._modelEventSubjects[e]=n);var r=n[t];return"undefined"==typeof r&&(r={preview:new b.Subject,normal:new b.Subject,committed:new b.Subject},n[t]=r),r}},{key:"_purgeEventQueues",value:function(){if(this._state.currentStatus===p["default"].Idle){for(var e=this._getNextModelRecordWithQueuedEvents(),t="undefined"!=typeof e;t;){for(;t;){this._state.moveToPreProcessing(e.modelId,e.model);var n=e.eventQueue.shift();e.model.unlock&&"function"==typeof e.model.unlock&&e.model.unlock();var r=new s["default"](e.modelId,n.eventType,n.event);if(e.runPreEventProcessor(e.model,n.event,r),!e.wasRemoved){if(!r.isCanceled)for(this._state.moveToEventDispatch();t;){var o=this._dispatchEventToEventProcessors(e.modelId,e.model,n.event,n.eventType,r);if(e.wasRemoved)break;!e.hasChanges&&o&&(e.hasChanges=!0),t=e.eventQueue.length>0,t&&(n=e.eventQueue.shift(),r=new s["default"](e.modelId,n.eventType,n.event))}e.wasRemoved||(this._state.moveToPostProcessing(),e.runPostEventProcessor(e.model,n.event,r),e.model.lock&&"function"==typeof e.model.lock&&e.model.lock())}this.broadcastEvent("modelChangedEvent",new g.ModelChangedEvent(e.modelId,n.eventType)),e=this._getNextModelRecordWithQueuedEvents(),t="undefined"!=typeof e}this._state.moveToDispatchModelUpdates(),this._dispatchModelUpdates(),e=this._getNextModelRecordWithQueuedEvents(),t="undefined"!=typeof e}this._state.moveToIdle()}}},{key:"_dispatchEventToEventProcessors",value:function(e,t,n,r,o){var i=function(e,t,n,r){var o=!1;if(r.getObserverCount()>0){if(r.onNext(e,t,n),r.hasError)throw r.error;o=!0}return o},u=this._getModelsEventSubjects(e,r),s=i(t,n,o,u.preview);if(o.isCommitted)throw new Error("You can't commit an event at the preview stage. Event: ["+o.eventType+"], ModelId: ["+e+"]");if(!o.isCanceled){if(s=i(t,n,o,u.normal),o.isCanceled)throw new Error("You can't cancel an event at the normal stage. Event: ["+o.eventType+"], ModelId: ["+e+"]");if(s&&o.isCommitted&&(i(t,n,o,u.committed),o.isCanceled))throw new Error("You can't cancel an event at the committed stage. Event: ["+o.eventType+"], ModelId: ["+e+"]")}return s}},{key:"_dispatchModelUpdates",value:function(){var e=[],t=void 0;for(var n in this._models)if(this._models.hasOwnProperty(n)){var r=this._models[n];r.hasChanges&&(r.hasChanges=!1,e.push(r))}for(var o=0,i=e.length;i>o;o++)if(t=this._modelUpdateSubjects[e[o].modelId],"undefined"!=typeof t&&(t.onNext(e[o].model),t.hasError))throw t.error}},{key:"_getNextModelRecordWithQueuedEvents",value:function(){var e=void 0;for(var t in this._models)if(this._models.hasOwnProperty(t)){var n=this._models[t];if(n.eventQueue.length>0){e=n;break}}return e}},{key:"_throwIfHalted",value:function(){if(this._state.currentStatus===p["default"].Halted){var e=m.utils.format("Event router halted due to previous error [{0}]",this._haltingException);throw new Error(e)}}},{key:"_halt",value:function(e){throw this._state.moveToHalted(),w.error("Router halted error: [{0}]",e),this._haltingException=e,e}}]),e}();t["default"]=k,e.exports=t["default"]},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),u=n(1),s=n(9),a=r(s),l=function(){function e(){o(this,e),this._currentStatus=a["default"].Idle}return i(e,[{key:"moveToIdle",value:function(){this._currentStatus=a["default"].Idle,this._clear()}},{key:"moveToPreProcessing",value:function(e,t){u.Guard.isString(e,"The modelId should be a string"),u.Guard.isDefined(t,"The model should be defined"),this._currentModelId=e,this._currentModel=t,this._currentStatus=a["default"].PreEventProcessing}},{key:"moveToEventDispatch",value:function(){this._currentStatus=a["default"].EventProcessorDispatch}},{key:"moveToPostProcessing",value:function(){this._currentStatus=a["default"].PostProcessing}},{key:"executeEvent",value:function(e){var t=this._currentStatus===a["default"].PreEventProcessing||this._currentStatus===a["default"].EventProcessorDispatch||this._currentStatus===a["default"].PostProcessing;u.Guard.isTrue(t,"Can't move to executing as the current state "+this._currentStatus+" doesn't allow it");var n=this._currentStatus;this._currentStatus=a["default"].EventExecution,e(),this._currentStatus=n}},{key:"moveToDispatchModelUpdates",value:function(){this._currentStatus=a["default"].DispatchModelUpdates}},{key:"moveToHalted",value:function(){this._currentStatus=a["default"].Halted,this._clear()}},{key:"_clear",value:function(){this._currentModelId=void 0,this._currentModel=void 0}},{key:"currentStatus",get:function(){return this._currentStatus}},{key:"currentModelId",get:function(){return this._currentModelId}},{key:"currentModel",get:function(){return this._currentModel}}]),e}();t["default"]=l,e.exports=t["default"]},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),u=n(3),s=(r(u),n(4)),a=r(s),l=function(){function e(){o(this,e),this._disposables=[],this._isDisposed=!1}return i(e,[{key:"add",value:function(e){var t=new a["default"](e);return this._isDisposed?void t.dispose():void this._disposables.push(t)}},{key:"dispose",value:function(){if(!this._isDisposed){this._isDisposed=!0;for(var e=0,t=this._disposables.length;t>e;e++){var n=this._disposables[e];n.dispose()}this._disposables.length=0}}},{key:"isDisposed",get:function(){return this._isDisposed}}]),e}();t["default"]=l,e.exports=t["default"]},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),
t}}(),u=n(4),s=r(u),a=function(){function e(){o(this,e),this._isDisposed=!1}return i(e,[{key:"add",value:function(e,t){if(this.hasOwnProperty(e))throw new Error("Key "+e+" already found");var n=new s["default"](t);return this._isDisposed?void n.dispose():void(this[e]=n)}},{key:"remove",value:function(e){this.hasOwnProperty(e)&&delete this[e]}},{key:"dispose",value:function(){this._isDisposed=!0;for(var e in this)if(this.hasOwnProperty(e)){var t=this[e];t.dispose&&t.dispose()}}}]),e}();t["default"]=a,e.exports=t["default"]},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(t,"__esModule",{value:!0});var o=n(27),i=r(o),u=n(28),s=r(u),a=n(4),l=r(a);t["default"]={CompositeDisposable:i["default"],DictionaryDisposable:s["default"],DisposableWrapper:l["default"]},e.exports=t["default"]},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e){return c["default"].isDefined(e,"The name argument should be defined"),c["default"].isString(e,"The name argument should be a string"),new v(e)}function u(e){d=e}function s(e){c["default"].isFunction(e,"Logging sink argument must be a function"),h=e}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}();t.create=i,t.setLevel=u,t.setSink=s;var l=n(3),c=r(l),f={verbose:0,debug:1,info:2,warn:3,error:4},d=f.debug,h=function(e){console.log("["+e.logger+"] ["+e.level+"]: "+e.message)},v=function(){function e(t){o(this,e),this._name=t}return a(e,[{key:"verbose",value:function(e){if(d<=f.verbose){var t=Array.prototype.slice.call(arguments,1);this._log("VERBOSE",e,t)}}},{key:"debug",value:function(e){if(d<=f.debug){var t=Array.prototype.slice.call(arguments,1);this._log("DEBUG",e,t)}}},{key:"info",value:function(e){if(d<=f.info){var t=Array.prototype.slice.call(arguments,1);this._log("INFO",e,t)}}},{key:"warn",value:function(e){if(d<=f.warn){var t=Array.prototype.slice.call(arguments,1);this._log("WARN",e,t)}}},{key:"error",value:function(e){if(d<=f.error){var t=Array.prototype.slice.call(arguments,1);this._log("ERROR",e,t)}}},{key:"_log",value:function(e,t,n){c["default"].isString(t,"First argument to a log function should be a string, but got ["+t+"]");var r=t.replace(/{(\d+)}/g,function(e,t){return"undefined"!=typeof n[t]?n[t]:e});h({logger:this._name,level:e,message:r})}}]),e}();t.levels=f}])});